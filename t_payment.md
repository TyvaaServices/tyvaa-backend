# Payment Integration Backend Guide for Tyvaa

This document explains the expected backend API and flow for integrating payments with the Tyvaa
mobile app. If you implement your backend according to this guide, the payment flow in the app will
work as expected.

## 1. Booking and Payment Flow

### Step 1: Book Ride (Create Booking)

- **Endpoint:** `POST /bookings`
- **Request Body:**
    ```json
    {
      "rideInstanceId": <int>,
      "seatsBooked": <int>,
      // Optionally: "userId": <int>, ...
    }
    ```
- **Response:**
    - Returns a `Booking` object, which must include a `Payment` object inside it.
    - The `Payment` object must have a unique `transactionId` generated by the backend.
    - Example response:
        ```json
        {
          "id": 123,
          "rideInstanceId": 456,
          "seatsBooked": 2,
          "status": "pending",
          "userId": 789,
          "rideInstance": { ... },
          "payment": {
            "transactionId": "TX1234567890",
            "amount": 5000,
            "status": "PENDING",
            // ...other fields
          }
        }
        ```

### Step 2: Initiate Payment

- The app uses the `transactionId` from the `Payment` object to initiate payment with CinetPay.
- The payment is performed on the client side using this ID.

### Step 3: Notify Backend of Payment Result

- **Endpoint:** `POST /payments/notify`
- **Request Body:**
    - Must include:
        - The `Booking` object (or at least its ID)
        - The `Payment` object (with updated status, transactionId, etc.)
        - The `PaymentResponse` object (raw response from CinetPay)
    - Example:
        ```json
        {
            "bookingId": 123,
            "payment": {
                "transactionId": "TX1234567890",
                "amount": 5000,
                "status": "COMPLETED"
                // ...
            },
            "paymentResponse": {
                "transaction_id": "TX1234567890",
                "amount": 5000,
                "currency": "XOF",
                "status": "ACCEPTED",
                "payment_method": "cinetpay",
                "description": "Paiement de trajet Tyvaa",
                "metadata": "...",
                "operator_id": "...",
                "payment_date": "2025-07-03T12:34:56Z"
            }
        }
        ```
- **Backend Action:**
    - Validate the payment result with CinetPay if needed.
    - Update the booking and payment status in your database.
    - Optionally, trigger notifications or other business logic.

## 2. Data Model Expectations

### Booking

- Must contain at least: `id`, `rideInstanceId`, `seatsBooked`, `status`, `userId`, `payment` (see
  above).

### Payment

- Must contain at least: `transactionId`, `amount`, `status` (PENDING, COMPLETED, FAILED), and any
  other fields you need.

### PaymentResponse

- Should store the raw response from CinetPay for traceability.

## 3. Error Handling

- If payment fails, the app may notify the backend with a failed status. Handle this gracefully.
- Always validate the transactionId and bookingId to avoid duplicates or fraud.

## 4. Security

- Only accept payment notifications for known bookings and transactionIds.
- Optionally, verify the payment status with CinetPay's API before marking as completed.

## 5. Example Sequence

1. App calls `POST /bookings` with ride and seat info.
2. Backend creates booking, generates payment with transactionId, returns full Booking (with
   Payment).
3. App initiates payment with CinetPay using transactionId.
4. App receives payment result, calls `POST /payments/notify` with bookingId, payment, and
   paymentResponse.
5. Backend updates booking/payment status and responds.

---

If you follow this contract, the Tyvaa app payment flow will work seamlessly with your backend.
